name: Trivy Scan (Renovate PR Only)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  trivy:
    runs-on: ubuntu-latest

    env:
      TRIVY_CACHE_DIR: .trivycache

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch base branch
        run: git fetch origin ${{ github.base_ref }}

      # ðŸ”¥ Cache Trivy DB
      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: .trivycache
          key: trivy-cache-${{ runner.os }}
          restore-keys: |
            trivy-cache-

      - name: Extract updated image from diff
        id: image
        run: |
          # Cherche le fichier helm-release modifiÃ© (yaml ou yml) dans tout le repo
          FILE=$(git diff --name-only origin/${{ github.base_ref }} | grep -E '(^|/)helm-release\.ya?ml$' | head -n1)

          if [ -z "$FILE" ]; then
            echo "NO_IMAGE=true" >> $GITHUB_ENV
            echo "No helm-release YAML file detected. Skipping scan."
            exit 0
          fi

          echo "Processing file: $FILE"

          # Utilise yq pour extraire repository + tag
          IMAGE=$(yq eval '
            .. | select(has("repository") and has("tag")) |
            .repository + ":" + .tag
          ' "$FILE" 2>/dev/null | head -n1)

          if [ -z "$IMAGE" ]; then
            echo "NO_IMAGE=true" >> $GITHUB_ENV
            echo "No image found in $FILE. Skipping scan."
          else
            echo "NO_IMAGE=false" >> $GITHUB_ENV
            echo "IMAGE=$IMAGE" >> $GITHUB_ENV
            echo "Detected image: $IMAGE"
          fi

      - name: Stop if no image changes
        if: env.NO_IMAGE == 'true'
        run: echo "No image changes detected. Skipping scan."

      - name: Setup & Scan with Trivy
        if: env.NO_IMAGE == 'false'
        uses: aquasecurity/trivy-action@0.34.0
        with:
          scan-type: 'image'
          image-ref: ${{ env.IMAGE }}
          format: 'json'
          output: 'result.json'
          severity: 'HIGH,CRITICAL'
          cache-dir: ${{ env.TRIVY_CACHE_DIR }}
        continue-on-error: true

      - name: Generate Markdown report
        if: env.NO_IMAGE == 'false'
        run: |
          IMAGE="${{ env.IMAGE }}"

          echo "# ðŸ” Trivy Scan Report" > report.md
          echo "" >> report.md

          # RÃ©sumÃ© global
          CRIT_TOTAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' result.json)
          HIGH_TOTAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="HIGH")] | length' result.json)
          MEDIUM_TOTAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' result.json)
          LOW_TOTAL=$(jq '[.Results[].Vulnerabilities[]? | select(.Severity=="LOW")] | length' result.json)

          echo "## ðŸ“Š RÃ©sumÃ©" >> report.md
          echo "- ðŸ”´ Critical: $CRIT_TOTAL" >> report.md
          echo "- ðŸ”¶ High: $HIGH_TOTAL" >> report.md
          echo "- ðŸŸ¡ Medium: $MEDIUM_TOTAL" >> report.md
          echo "- ðŸŸ¢ Low: $LOW_TOTAL" >> report.md
          echo "" >> report.md

          TOTAL_VULNS=$((CRIT_TOTAL + HIGH_TOTAL + MEDIUM_TOTAL + LOW_TOTAL))

          if [ "$TOTAL_VULNS" -eq 0 ]; then
            echo "âœ… Aucune faille dÃ©tectÃ©e pour cette image." >> report.md
          else
            echo "---" >> report.md
            echo "" >> report.md
            echo "## ðŸ³ Image: $IMAGE" >> report.md
            echo "" >> report.md

            for SEV in CRITICAL HIGH MEDIUM LOW; do
              COUNT=$(jq "[.Results[].Vulnerabilities[]? | select(.Severity==\"$SEV\")] | length" result.json)
              if [ "$COUNT" -gt 0 ]; then
                echo "### $SEV ($COUNT)" >> report.md

                # RÃ©cupÃ¨re les vulnÃ©rabilitÃ©s de cette sÃ©vÃ©ritÃ©
                jq -r --arg SEV "$SEV" '
                  .Results[].Vulnerabilities[]? | select(.Severity==$SEV) |
                  "- **\(.PkgName)** \(.InstalledVersion) â†’ \(.FixedVersion // "N/A") (`\(.VulnerabilityID)`) - \(.PrimaryURL // "no link")"
                ' result.json > tmp_$SEV.txt

                # Affiche les 3 premiÃ¨res
                head -n3 tmp_$SEV.txt >> report.md

                # Si plus de 3, les replier sous <details>
                TOTAL=$(wc -l < tmp_$SEV.txt)
                if [ "$TOTAL" -gt 3 ]; then
                  echo -e "<details><summary>$((TOTAL-3)) autres...</summary>\n" >> report.md
                  tail -n+$((3+1)) tmp_$SEV.txt >> report.md
                  echo "</details>" >> report.md
                fi

                echo "" >> report.md
                rm tmp_$SEV.txt
              fi
            done
          fi

      - name: Upsert PR Comment
        if: env.NO_IMAGE == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('report.md', 'utf8');
            const marker = '<!-- trivy-report -->';
            const finalBody = marker + '\n' + body;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const existing = comments.find(c => c.body.startsWith(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: finalBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: finalBody
              });
            }