apiVersion: batch/v1
kind: CronJob
metadata:
  name: home-assistant-db-backup
  namespace: restic
spec:
  schedule: "30 1 * * 0" # Tous les dimanches Ã  1h30 UTC
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: restic-home-assistant-db
              image: ghcr.io/seblaporte/restic
              imagePullPolicy: Always
              env:
                - name: RESTIC_PASSWORD
                  value: ${SECRET_RESTIC_PASSWORD}
                - name: RESTIC_REPOSITORY
                  value: ${SECRET_RESTIC_REPOSITORY}
                - name: OS_STORAGE_URL
                  value: ${SECRET_RESTIC_OS_STORAGE_URL}
                - name: OS_AUTH_TOKEN
                  value: ${SECRET_RESTIC_OS_AUTH_TOKEN}
                - name: MYSQL_PWD
                  value: ${SECRET_HOME_ASSISTANT_DB_PASSWORD}
              command: ["/bin/sh", "-c"]
              args:
                - "mysqldump -u home-assistant --skip-dump-date --force --port 3339 --host 192.168.1.10 home-assistant | "
                - "gzip --rsyncable | "
                - "restic backup --stdin --stdin-filename databases/home-assistant.sql.gz --tag mariadb --tag home-assistant"
          restartPolicy: OnFailure
