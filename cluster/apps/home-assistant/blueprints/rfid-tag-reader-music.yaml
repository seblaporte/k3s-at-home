blueprint:
  name: RFID Card â†’ Music Assistant (Track Selector)
  description: >
    Carte RFID individuelle.
    SÃ©lection dâ€™un mÃ©dia via le navigateur Music Assistant.

  domain: automation

  input:
    tag_id:
      name: Tag RFID
      selector:
        text:

    media_content:
      name: Lecteur et mÃ©dia associÃ© (Track / Album / Playlist)
      selector:
        media:

mode: restart

trigger:
  - platform: tag
    tag_id: !input tag_id

variables:
  selected_media: !input media_content

  current_uid: "{{ trigger.event.data.tag_id }}"

  target_player: >
    {% if trigger.event.data.device_id == states('input_text.lecteur_rfid_salon') %}
      media_player.chromecast_hi_fi_2
    {% elif trigger.event.data.device_id == states('input_text.lecteur_rfid_etage') %}
      media_player.google_nest_palier_2
    {% else %}
      none
    {% endif %}

  last_uid_helper: >
    {% if target_player == 'media_player.chromecast_hi_fi_2' %}
      input_text.lecteur_rfid_salon_derniere_carte_scannee
    {% elif target_player == 'media_player.google_nest_palier_2' %}
      input_text.lecteur_rfid_etage_derniere_carte_scannee
    {% endif %}

  last_type_helper: >
    {% if target_player == 'media_player.chromecast_hi_fi_2' %}
      input_text.lecteur_rfid_salon_dernier_type_media
    {% elif target_player == 'media_player.google_nest_palier_2' %}
      input_text.lecteur_rfid_etage_dernier_type_media
    {% endif %}

  last_uid: "{{ states(last_uid_helper) }}"
  last_type: "{{ states(last_type_helper) }}"
  media_type: "{{ selected_media.media_content_type }}"

  activation_helper: >
    {% if target_player == 'media_player.chromecast_hi_fi_2' %}
      input_boolean.lecteur_rfid_salon_activation
    {% elif target_player == 'media_player.google_nest_palier_2' %}
      input_boolean.lecteur_rfid_etage_activation
    {% else %}
      none
    {% endif %}

condition:
  - condition: template
    value_template: >
      {{ target_player != 'none'
         and activation_helper != 'none'
         and is_state(activation_helper, 'on') }}

action:
  - choose:

      ##########################################################
      # ğŸ” RESCAN MÃŠME CARTE
      ##########################################################
      - conditions:
          - condition: template
            value_template: >
              {{ current_uid == last_uid
                 and media_type == last_type }}
        sequence:

          - choose:

              # ğŸµ Si c'Ã©tait une musique â†’ ne rien faire
              - conditions:
                  - condition: template
                    value_template: "{{ last_type in ['music','track'] }}"
                sequence: []

              # ğŸ“€ Si c'Ã©tait une playlist â†’ suivant
              - conditions:
                  - condition: template
                    value_template: "{{ last_type == 'playlist' }}"
                sequence:
                  - service: music_assistant.play_announcement
                    data:
                      entity_id: "{{ target_player }}"
                      media_id: "/local/sounds/magic-chime.mp3"
                  - service: media_player.media_next_track
                    target:
                      entity_id: "{{ target_player }}"

    ##########################################################
    # ğŸ†• NOUVELLE CARTE
    ##########################################################
    default:

      # ğŸ”” Son dâ€™acquittement
      - service: music_assistant.play_announcement
        data:
          entity_id: "{{ target_player }}"
          media_id: "/local/sounds/magic-chime.mp3"

      # â–¶ï¸ Lecture du mÃ©dia
      - service: media_player.play_media
        target:
          entity_id: "{{ target_player }}"
        data:
          media_content_id: "{{ selected_media.media_content_id }}"
          media_content_type: "{{ selected_media.media_content_type }}"

      # ğŸ² Si playlist â†’ activer shuffle
      - if:
          - condition: template
            value_template: "{{ media_type == 'playlist' }}"
        then:
          - service: media_player.shuffle_set
            target:
              entity_id: "{{ target_player }}"
            data:
              shuffle: true

      # ğŸµ Si musique â†’ dÃ©sactiver shuffle
      - if:
          - condition: template
            value_template: "{{ media_type in ['music','track'] }}"
        then:
          - service: media_player.shuffle_set
            target:
              entity_id: "{{ target_player }}"
            data:
              shuffle: false

      # ğŸ’¾ Sauvegarde UID
      - service: input_text.set_value
        target:
          entity_id: "{{ last_uid_helper }}"
        data:
          value: "{{ current_uid }}"

      # ğŸ’¾ Sauvegarde type
      - service: input_text.set_value
        target:
          entity_id: "{{ last_type_helper }}"
        data:
          value: "{{ media_type }}"